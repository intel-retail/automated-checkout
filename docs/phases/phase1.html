
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.0, mkdocs-material-8.5.6">
    
    
      
        <title>Phase 1 - Simulation Mode - Automated Checkout</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.20d9efc8.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#phase-1-simulation-mode" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../index.html" title="Automated Checkout" class="md-header__button md-logo" aria-label="Automated Checkout" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Automated Checkout
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Phase 1 - Simulation Mode
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="Automated Checkout" class="md-nav__button md-logo" aria-label="Automated Checkout" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Automated Checkout
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        Automated Checkout Reference Implementation
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Phases
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Phases" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Phases
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Phase 1 - Simulation Mode
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="phase1.html" class="md-nav__link md-nav__link--active">
        Phase 1 - Simulation Mode
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview
  </a>
  
    <nav class="md-nav" aria-label="Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scenarios" class="md-nav__link">
    Scenarios
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-started" class="md-nav__link">
    Getting started
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#walkthrough-of-scenarios" class="md-nav__link">
    Walkthrough of scenarios
  </a>
  
    <nav class="md-nav" aria-label="Walkthrough of scenarios">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-stock-the-cooler-with-inventory" class="md-nav__link">
    1. Stock the cooler with inventory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-purchase-from-the-cooler-as-a-customer" class="md-nav__link">
    2. Purchase from the cooler as a customer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-the-cooler-requires-maintenance" class="md-nav__link">
    3. The cooler requires maintenance
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="phase2.html" class="md-nav__link">
        Phase 2 - Add Card Reader Device
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="phase3.html" class="md-nav__link">
        Phase 3 - Bring Your Own Hardware and Software
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Additional Documentation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Additional Documentation" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Additional Documentation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1" type="checkbox" id="__nav_3_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3_1">
          Automated Checkout Services
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Automated Checkout Services" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          Automated Checkout Services
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../automated-checkout-services/device_services.html" class="md-nav__link">
        Device Services
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../automated-checkout-services/application_services.html" class="md-nav__link">
        Application Services
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../automated-checkout-services/micro_services.html" class="md-nav__link">
        Other Microservices
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../events.html" class="md-nav__link">
        Automated Checkout Events
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../configuration.html" class="md-nav__link">
        Configuration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../modifying_source_code.html" class="md-nav__link">
        Modifying source code
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../notifications.html" class="md-nav__link">
        How to Send Notifications through EdgeX (optional)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../references.html" class="md-nav__link">
        References
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../troubleshooting.html" class="md-nav__link">
        Troubleshooting
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview
  </a>
  
    <nav class="md-nav" aria-label="Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scenarios" class="md-nav__link">
    Scenarios
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-started" class="md-nav__link">
    Getting started
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#walkthrough-of-scenarios" class="md-nav__link">
    Walkthrough of scenarios
  </a>
  
    <nav class="md-nav" aria-label="Walkthrough of scenarios">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-stock-the-cooler-with-inventory" class="md-nav__link">
    1. Stock the cooler with inventory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-purchase-from-the-cooler-as-a-customer" class="md-nav__link">
    2. Purchase from the cooler as a customer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-the-cooler-requires-maintenance" class="md-nav__link">
    3. The cooler requires maintenance
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="phase-1-simulation-mode">Phase 1 - Simulation Mode</h1>
<h2 id="overview">Overview</h2>
<p>This document aims to help provide a simple introduction to how we interact with the various microservices in the Automated Checkout reference implementation, as well as demonstrating how EdgeX command API's are leveraged.</p>
<p>The steps in this guide show how to simulate the automated checkout workflow using <a href="https://github.com/curl/curl"><code>curl</code></a> REST API calls. It is a step-by-step walkthrough with specific commands to run on the command line.</p>
<p>The documentation in <a href="phase2.html">phase 2</a> and <a href="phase3.html">phase 3</a> will discuss more advanced methods of adding physical hardware and customized device services.</p>
<h3 id="scenarios">Scenarios</h3>
<p>This walkthrough completes the following three scenarios:</p>
<ul>
<li><a href="#phase-1---simulation-mode">Phase 1 - Simulation Mode</a></li>
<li><a href="#overview">Overview</a><ul>
<li><a href="#scenarios">Scenarios</a></li>
</ul>
</li>
<li><a href="#getting-started">Getting started</a></li>
<li><a href="#walkthrough-of-scenarios">Walkthrough of scenarios</a><ul>
<li><a href="#1-stock-the-cooler-with-inventory">1. Stock the cooler with inventory</a></li>
<li><a href="#2-purchase-from-the-cooler-as-a-customer">2. Purchase from the cooler as a customer</a></li>
<li><a href="#3-the-cooler-requires-maintenance">3. The cooler requires maintenance</a></li>
</ul>
</li>
<li><a href="#summary">Summary</a></li>
</ul>
<h2 id="getting-started">Getting started</h2>
<ol>
<li>Complete steps 1-4 in <a href="../index.html#step-1-clone-the-repository">Getting Started</a>.</li>
<li>Make sure the containers are all up and running (aside from <code>edgex-config-seed</code>): <code>docker-compose ps</code></li>
<li>Make sure the services are not running in maintenance mode:</li>
</ol>
<div class="codehilite"><pre><span></span><code>curl -X GET http://localhost:48099/maintenanceMode
</code></pre></div>

<p>Verify the output and make sure that <code>maintenanceMode</code> value is set to false.</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{\&quot;maintenanceMode\&quot;:false}&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;json&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;statusCode&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>If <code>maintenanceMode</code> is set to true, run the following command to reset state machine:</p>
<div class="codehilite"><pre><span></span><code>docker-compose -f docker-compose.ac.yml restart as-vending ds-controller-board as-controller-board-status
</code></pre></div>

<ol>
<li>In a separate terminal window, watch the logs for a few Automated Checkout services, so that incoming events can be seen:</li>
</ol>
<div class="codehilite"><pre><span></span><code>docker-compose -f docker-compose.ac.yml logs -f ds-card-reader ds-controller-board ms-authentication as-vending as-controller-board-status
</code></pre></div>

<div class="admonition info">
<p class="admonition-title">Info</p>
<p>The output from <code>ds-controller-board</code> and <code>as-controller-board-status</code> may be noisy due to an automated status check occurring every 3 seconds. It may be desirable to try watching logs without those two services.</p>
<p>Additionally, using Portainer to watch Docker compose service logs can be extremely helpful. Start it by running:</p>
<p><code>make run-portainer</code></p>
<p>Then, navigate to <code>http://localhost:9000/</code> in a web browser.</p>
</div>
<p>Continue to the next section to start using <code>curl</code> to run through the simulated scenarios.</p>
<h2 id="walkthrough-of-scenarios">Walkthrough of scenarios</h2>
<p>Each section below contains specific steps and expected output for each of the scenarios mentioned above.</p>
<h3 id="1-stock-the-cooler-with-inventory">1. Stock the cooler with inventory</h3>
<p>In order to fill up the cooler with inventory, someone acting as a "stocker" must swipe their card and proceed to fill the Automated Checkout with products.</p>
<p>However, before we get started, it's important to keep a few things in mind. We will perform a very specific sequence of events:</p>
<ol>
<li>Swipe badge</li>
<li>Open the cooler door</li>
<li>Close the cooler door</li>
<li>Verify that the cooler's inventory has been populated</li>
<li>Verify that the cooler's audit log shows the transaction</li>
</ol>
<p>That's it! Each of the above actions has a corresponding REST API call that we will run using the <code>curl</code> program on the command line.</p>
<p align="center">
    <img src="../images/stocker.png">
</p>

<p>For visualization purposes, the CV inference service serves the post-processed images over http. Open <a href="http://127.0.0.1:9005" target=_blank>http://127.0.0.1:9005</a> on your web browser to observe how products are being added or removed to the cooler.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>This sequence of events is time-sensitive. Once started, you must continue the sequence.</strong></p>
<p><strong>Once someone has swiped their card, the cooler door unlocks, and the person has roughly 20 seconds (configurable) to open the door before it locks again, if unopened.</strong> With this in mind, prepare to run this command, and the following commands soon after.</p>
<p>It's OK to run the commands without critically analyzing them <em>in the moment</em>. You may find it most useful to review them in advance.</p>
<p>If you mess up, you should start fresh. Run the command <code>make down &amp;&amp; make clean-docker &amp;&amp; make run</code> to scrub the Automated Checkout data and containers, wait approximately one minute after all services have started, and begin again. This scenario does not have any dependencies on the other scenarios in phase 1.</p>
</div>
<p>The following diagram represents the flow for swiping your badge and unlocking the door:</p>
<p align="center">
    <img src="../images/card-unlock.png">
</p>

<p>To simulate this, perform this REST API call to the <code>ds-card-reader</code> service <strong><em>(time sensitive)</em></strong>:</p>
<div class="codehilite"><pre><span></span><code>curl -X PUT -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -d <span class="s1">&#39;{&quot;card-number&quot;:&quot;0003293374&quot;}&#39;</span> http://localhost:48098/api/v2/device/name/card-reader/card-number
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There should not be any response message when running this EdgeX command successfully.</p>
</div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>By default, the card number <code>0003293374</code> corresponds to a card in the <a href="https://github.com/intel-iot-devkit/automated-checkout/blob/master/ms-authentication/cards.json"><code>ms-authentication/cards.json</code></a> file that has the "stocker" role associated to it.</p>
</div>
<p>JSON object for <code>cardId</code> 0003293374.</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;cardId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0003293374&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;roleId&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;isValid&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;personId&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;createdAt&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1560815799&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;updatedAt&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1560815799&quot;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>Immediately after, use the <code>as-controller-board-status</code> <code>/status</code> API endpoint to verify that the lock is unlocked <strong><em>(time sensitive)</em></strong>:</p>
<div class="codehilite"><pre><span></span><code>curl -X GET http://localhost:48094/status
</code></pre></div>

<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The lock must have a reading of 0 (unlocked) before proceeding to the next steps. If you attempt to open the door while the lock is engaged the system will assume an error state has occurred and go into maintenance mode.</p>
</div>
<details>
    <summary><i>(Click to Expand)</i> Expected Response</summary>

<p>
  Note that the <code>lock1_status</code> is set to <code>0</code>, implying that <code>lock1</code> has been unlocked. It will only stay unlocked for (default) 15 seconds, until the door is opened, at which time an independent timer is started that waits (default) 20 seconds for the stocker (or customer) to close the door after altering inventory.
</p>


<div class="codehilite"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;{ \&quot;lock1_status\&quot;:0,</span>
<span class="s2">              \&quot;lock2_status\&quot;:1,</span>
<span class="s2">              \&quot;door_closed\&quot;:true,</span>
<span class="s2">              \&quot;temperature\&quot;:78,</span>
<span class="s2">              \&quot;humidity\&quot;:10,</span>
<span class="s2">              \&quot;minTemperatureStatus\&quot;:false,</span>
<span class="s2">              \&quot;maxTemperatureStatus\&quot;:false</span>
<span class="s2">            }&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="s2">&quot;json&quot;</span><span class="p">,</span><span class="nt">&quot;statusCode&quot;</span><span class="p">:</span><span class="mi">200</span><span class="p">,</span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="kc">false</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



</details>

<p>Then open the door, and close it afterwards, while waiting approximately 3-4 seconds between each event using the following 2 commands.</p>
<p>The following command makes a REST API call to the <code>ds-controller-board</code> service to open the door (no response body expected) <strong><em>(time sensitive)</em></strong>:</p>
<div class="codehilite"><pre><span></span><code>curl -X PUT -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -d <span class="s1">&#39;{&quot;setDoorClosed&quot;:&quot;0&quot;}&#39;</span> http://localhost:48097/api/v2/device/name/controller-board/setDoorClosed
</code></pre></div>

<p>Wait 3.75 seconds:</p>
<div class="codehilite"><pre><span></span><code>sleep <span class="m">3</span>.75
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Waiting around 3-4 seconds is necessary because the frequency of "auto-events" that relay readings between some services is set to 3 seconds by default.</p>
<p>This implies that, for example, if you open and close the cooler door within the span of 1-2 seconds, there is a possibility that the auto-event did not pick up the change in the state of the door since its state did not change <em>from one auto-event to the next</em>.</p>
</div>
<p>The following command makes a REST API call to the <code>ds-controller-board</code> service to close the door (no response body expected) <strong><em>(time sensitive)</em></strong>:</p>
<div class="codehilite"><pre><span></span><code>curl -X PUT -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -d <span class="s1">&#39;{&quot;setDoorClosed&quot;:&quot;1&quot;}&#39;</span> http://localhost:48097/api/v2/device/name/controller-board/setDoorClosed
</code></pre></div>

<p>Wait about 20-30 seconds for the inventory to be discovered by the CV inference service, and also for background processing of events to occur. <strong>The time-sensitive sequence has been completed.</strong></p>
<p>The following diagram represents the flow for opening and closing the door:</p>
<p align="center">
    <img src="../images/open-close-door.png">
</p>

<p>After waiting, use the following API calls to check the inventory, audit log, and ledger <strong><em>(not time sensitive)</em></strong>:</p>
<div class="codehilite"><pre><span></span><code>curl -X GET http://localhost:48095/inventory
</code></pre></div>

<details>
  <summary><i>(Click to Expand)</i> Inventory API Response Example</summary>

<p>
The (altered) contents of <a href="https://github.com/intel-iot-devkit/automated-checkout/blob/master/ms-inventory/inventory.json"><code>ms-inventory/inventory.json</code></a> are contained in the <code>content</code> key below.
</p>


<div class="codehilite"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{\&quot;data\&quot;:[</span>
<span class="s2">      {\&quot;sku\&quot;:\&quot;4900002470\&quot;,\&quot;itemPrice\&quot;:1.99,\&quot;productName\&quot;:\&quot;Sprite (Lemon-Lime) - 16.9 oz\&quot;,\&quot;unitsOnHand\&quot;:2,\&quot;maxRestockingLevel\&quot;:24,\&quot;minRestockingLevel\&quot;:0,\&quot;createdAt\&quot;:\&quot;1567787309\&quot;,\&quot;updatedAt\&quot;:\&quot;1567787309\&quot;,\&quot;isActive\&quot;:true},</span>
<span class="s2">      {\&quot;sku\&quot;:\&quot;4900002500\&quot;,\&quot;itemPrice\&quot;:1.99,\&quot;productName\&quot;:\&quot;Mountain Dew - 16.9 oz\&quot;,\&quot;unitsOnHand\&quot;:0,\&quot;maxRestockingLevel\&quot;:6,\&quot;minRestockingLevel\&quot;:0,\&quot;createdAt\&quot;:\&quot;1567787309\&quot;,\&quot;updatedAt\&quot;:\&quot;1567787309\&quot;,\&quot;isActive\&quot;:true},</span>
<span class="s2">      {\&quot;sku\&quot;:\&quot;4900002510\&quot;,\&quot;itemPrice\&quot;:1.99,\&quot;productName\&quot;:\&quot;Gatorade - 16.9 oz\&quot;,\&quot;unitsOnHand\&quot;:2,\&quot;maxRestockingLevel\&quot;:24,\&quot;minRestockingLevel\&quot;:0,\&quot;createdAt\&quot;:\&quot;1567787309\&quot;,\&quot;updatedAt\&quot;:\&quot;1567787309\&quot;,\&quot;isActive\&quot;:true},</span>
<span class="s2">      {\&quot;sku\&quot;:\&quot;4900002525\&quot;,\&quot;itemPrice\&quot;:1.99,\&quot;productName\&quot;:\&quot;Pringles\&quot;,\&quot;unitsOnHand\&quot;:2,\&quot;maxRestockingLevel\&quot;:32,\&quot;minRestockingLevel\&quot;:0,\&quot;createdAt\&quot;:\&quot;1567787309\&quot;,\&quot;updatedAt\&quot;:\&quot;1567787309\&quot;,\&quot;isActive\&quot;:true},</span>
<span class="s2">      {\&quot;sku\&quot;:\&quot;4900002520\&quot;,\&quot;itemPrice\&quot;:1.99,\&quot;productName\&quot;:\&quot;Ruffles\&quot;,\&quot;unitsOnHand\&quot;:1,\&quot;maxRestockingLevel\&quot;:12,\&quot;minRestockingLevel\&quot;:0,\&quot;createdAt\&quot;:\&quot;1567787309\&quot;,\&quot;updatedAt\&quot;:\&quot;1567787309\&quot;,\&quot;isActive\&quot;:true}</span>
<span class="s2">    ]}&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;json&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;statusCode&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



</details>

<div class="codehilite"><pre><span></span><code>curl -X GET http://localhost:48095/auditlog
</code></pre></div>

<details>
  <summary><i>(Click to Expand)</i> Audit Log API Response Example</summary>

<p>
The (altered) contents of <a href="https://github.com/intel-iot-devkit/automated-checkout/blob/master/ms-inventory/auditlog.json"><code>ms-inventory/auditlog.json</code></a> are contained in the <code>content</code> key below.
</p>


<div class="codehilite"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{\&quot;data\&quot;:[{\&quot;cardId\&quot;:\&quot;0003293374\&quot;,\&quot;accountId\&quot;:1,\&quot;roleId\&quot;:2,\&quot;personId\&quot;:1,\&quot;inventoryDelta\&quot;:[{\&quot;SKU\&quot;:\&quot;4900002520\&quot;,\&quot;delta\&quot;:1},{\&quot;SKU\&quot;:\&quot;4900002525\&quot;,\&quot;delta\&quot;:2},{\&quot;SKU\&quot;:\&quot;4900002470\&quot;,\&quot;delta\&quot;:2},{\&quot;SKU\&quot;:\&quot;4900002510\&quot;,\&quot;delta\&quot;:2}],\&quot;createdAt\&quot;:\&quot;1585088126815981442\&quot;,\&quot;auditEntryId\&quot;:\&quot;4c1bca23-b097-4750-8a3b-43cc09733425\&quot;}]}&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;json&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;statusCode&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



</details>

<div class="codehilite"><pre><span></span><code>curl -X GET http://localhost:48093/ledger
</code></pre></div>

<details>
  <summary><i>(Click to Expand)</i> Ledger API Response Example</summary>

<p>
Since this a stocking event and not a customer transaction, there is no ledger entry for this transaction. Later in this walkthrough, similar steps will be followed that <i>will</i> yield a financial transaction and hence, a ledger entry.
</p>

<p>
By default, the ledger service has six registered accounts (accounts 1-6) for consumers. The valid accounts match the account ID's that have authorized access to the cooler through the <code>ms-authentication</code> service (see the <a href="https://github.com/intel-iot-devkit/automated-checkout/blob/master/ms-authentication/accounts.json"><code>ms-authentication/accounts.json</code></a> file).
</p>

<p>
The (unaltered) contents of <a href="https://github.com/intel-iot-devkit/automated-checkout/blob/master/ms-ledger/ledger.json"><code>ms-ledger/ledger.json</code></a> are contained in the <code>content</code> key below.
</p>


<div class="codehilite"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{\&quot;data\&quot;:[</span>
<span class="s2">                          {\&quot;accountID\&quot;:1,\&quot;ledgers\&quot;:[]},</span>
<span class="s2">                          {\&quot;accountID\&quot;:2,\&quot;ledgers\&quot;:[]},</span>
<span class="s2">                          {\&quot;accountID\&quot;:3,\&quot;ledgers\&quot;:[]},</span>
<span class="s2">                          {\&quot;accountID\&quot;:4,\&quot;ledgers\&quot;:[]},</span>
<span class="s2">                          {\&quot;accountID\&quot;:5,\&quot;ledgers\&quot;:[]},</span>
<span class="s2">                          {\&quot;accountID\&quot;:6,\&quot;ledgers\&quot;:[]}</span>
<span class="s2">                       ]</span>
<span class="s2">              }&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;json&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;statusCode&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



</details>

<p><strong>That's it!</strong> The cooler has been populated with inventory, and the audit log and inventory both show evidence of this.</p>
<h3 id="2-purchase-from-the-cooler-as-a-customer">2. Purchase from the cooler as a customer</h3>
<p>Now that the cooler's inventory has been stocked, we can simulate a customer swiping their card and removing one or more items from the cooler for purchase. The same time-sensitive disclaimers from the stocking simulation (which was done earlier in this walkthrough) apply here as well, so please review the <a href="#Stock-the-cooler-with-Inventory">Stock the Cooler with Inventory</a> section if you have not done so yet.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you have not already populated the inventory as described in the <a href="#Stock-the-Cooler-with-Inventory">Stock the Cooler with Inventory</a> section, do not proceed. The inferencing service follows a specific sequence for changes in inventory. The first transaction in the sequence is always a <em>gain</em> of inventory, corresponding to the stocker adding items to inventory. The following transactions are <em>removal</em> of inventory, corresponding to customers <em>taking</em> items from inventory.</p>
<p>If you mess up, you should start fresh. Run the command <code>make down &amp;&amp; make clean-docker &amp;&amp; make run</code> to scrub the Automated Checkout data and containers, wait approximately one minute after all services have started, and begin again. This scenario relies on the stocking scenario in phase 1 - if the stocking scenario is skipped, it is still OK, but the randomized sequence of transactions will yield inventory/audit log/ledger changes that differ from the expected examples shown throughout this scenario.</p>
</div>
<p>In a manner similar to the previous section (where we stocked our inventory), the following steps are taken when simulating a customer:</p>
<ol>
<li>Swipe badge</li>
<li>Open the cooler door</li>
<li>Close the cooler door</li>
<li>Verify that the cooler's inventory has been altered</li>
<li>Verify that the cooler's audit log shows the transaction</li>
<li>Verify that the cooler's ledger shows the transaction</li>
</ol>
<p>That's it! Each of the above actions has a corresponding REST API call that we will run using the <code>curl</code> program on the command line.</p>
<p align="center">
    <img src="../images/customer.png">
</p>

<p>To begin, start by performing the following REST command to simulate a customer swiping their badge to open the cooler <strong><em>(time sensitive)</em></strong>:</p>
<div class="codehilite"><pre><span></span><code>curl -X PUT -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -d <span class="s1">&#39;{&quot;card-number&quot;:&quot;0003278380&quot;}&#39;</span> http://localhost:48098/api/v2/device/name/card-reader/card-number
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There should not be any response message when running this EdgeX command successfully.</p>
</div>
<p>Immediately after, just as before, use the <code>as-controller-board-status</code> <code>/status</code> API endpoint to verify that the lock is unlocked <strong><em>(time sensitive)</em></strong>:</p>
<div class="codehilite"><pre><span></span><code>curl -X GET http://localhost:48094/status
</code></pre></div>

<details>
    <summary><i>(Click to Expand)</i> Expected Response</summary>
<p>
  Note that the <code>lock1_status</code> is set to <code>0</code>, implying that <code>lock1</code> has been unlocked. It will only stay unlocked for (default) 15 seconds, until the door is opened, at which time an independent timer is started that waits (default) 20 seconds for the customer (or stocker) to close the door after altering inventory.
</p>


<div class="codehilite"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;{ \&quot;lock1_status\&quot;:0,</span>
<span class="s2">               \&quot;lock2_status\&quot;:1,</span>
<span class="s2">               \&quot;door_closed\&quot;:true,</span>
<span class="s2">               \&quot;temperature\&quot;:78,</span>
<span class="s2">               \&quot;humidity\&quot;:10,</span>
<span class="s2">               \&quot;minTemperatureStatus\&quot;:false,</span>
<span class="s2">               \&quot;maxTemperatureStatus\&quot;:false</span>
<span class="s2">            }&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="s2">&quot;json&quot;</span><span class="p">,</span><span class="nt">&quot;statusCode&quot;</span><span class="p">:</span><span class="mi">200</span><span class="p">,</span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="kc">false</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



</details>

<p>Then open the door, and close it afterwards, while waiting approximately 3-4 seconds between each event using the following 2 commands.</p>
<p>The following command makes a REST API call to the <code>ds-controller-board</code> service to open the door (no response body expected) <strong><em>(time sensitive)</em></strong>:</p>
<div class="codehilite"><pre><span></span><code>curl -X PUT -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -d <span class="s1">&#39;{&quot;setDoorClosed&quot;:&quot;0&quot;}&#39;</span> http://localhost:48097/api/v2/device/name/controller-board/setDoorClosed
</code></pre></div>

<p>Wait 3.75 seconds:</p>
<div class="codehilite"><pre><span></span><code>sleep <span class="m">3</span>.75
</code></pre></div>

<p>The following command makes a REST API call to the <code>ds-controller-board</code> service to close the door (no response body expected) <strong><em>(time sensitive)</em></strong>:</p>
<div class="codehilite"><pre><span></span><code>curl -X PUT -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -d <span class="s1">&#39;{&quot;setDoorClosed&quot;:&quot;1&quot;}&#39;</span> http://localhost:48097/api/v2/device/name/controller-board/setDoorClosed
</code></pre></div>

<p>At this point we are done simulating customer interactions with the Automated Checkout. The next steps are to get the inventory, ledger, and audit logs, and verify that they all show consistent information <strong><em>(not time sensitive, but may need to wait 20-30 seconds for background processing)</em></strong>:</p>
<div class="codehilite"><pre><span></span><code>curl -X GET http://localhost:48095/inventory
</code></pre></div>

<details>
  <summary><i>(Click to Expand)</i> Inventory API Response Example</summary>

<p>
A few items have been removed from the inventory in the below API response. Carefully examine the <code>unitsOnHand</code> and note that some items are no longer fully stocked by also examining the <code>maxRestockingLevel</code>. It may be extra insightful to compare this to the stocker section's inventory API response example, and also even more insightful to take a look at the below audit log and ledger responses for a proper view of the inventory delta that took place.
</p>

<p>
The (altered) contents of <a href="https://github.com/intel-iot-devkit/automated-checkout/blob/master/ms-inventory/inventory.json"><code>ms-inventory/inventory.json</code></a> are contained in the <code>content</code> key below.
</p>


<div class="codehilite"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{\&quot;data\&quot;{\&quot;data\&quot;:[</span>
<span class="s2">      {\&quot;sku\&quot;:\&quot;4900002470\&quot;,\&quot;itemPrice\&quot;:1.99,\&quot;productName\&quot;:\&quot;Sprite (Lemon-Lime) - 16.9 oz\&quot;,\&quot;unitsOnHand\&quot;:2,\&quot;maxRestockingLevel\&quot;:24,\&quot;minRestockingLevel\&quot;:0,\&quot;createdAt\&quot;:\&quot;1567787309\&quot;,\&quot;updatedAt\&quot;:\&quot;1567787309\&quot;,\&quot;isActive\&quot;:true},</span>
<span class="s2">      {\&quot;sku\&quot;:\&quot;4900002500\&quot;,\&quot;itemPrice\&quot;:1.99,\&quot;productName\&quot;:\&quot;Mountain Dew - 16.9 oz\&quot;,\&quot;unitsOnHand\&quot;:0,\&quot;maxRestockingLevel\&quot;:6,\&quot;minRestockingLevel\&quot;:0,\&quot;createdAt\&quot;:\&quot;1567787309\&quot;,\&quot;updatedAt\&quot;:\&quot;1567787309\&quot;,\&quot;isActive\&quot;:true},</span>
<span class="s2">      {\&quot;sku\&quot;:\&quot;4900002510\&quot;,\&quot;itemPrice\&quot;:1.99,\&quot;productName\&quot;:\&quot;Gatorade - 16.9 oz\&quot;,\&quot;unitsOnHand\&quot;:1,\&quot;maxRestockingLevel\&quot;:24,\&quot;minRestockingLevel\&quot;:0,\&quot;createdAt\&quot;:\&quot;1567787309\&quot;,\&quot;updatedAt\&quot;:\&quot;1567787309\&quot;,\&quot;isActive\&quot;:true},</span>
<span class="s2">      {\&quot;sku\&quot;:\&quot;4900002525\&quot;,\&quot;itemPrice\&quot;:1.99,\&quot;productName\&quot;:\&quot;Pringles\&quot;,\&quot;unitsOnHand\&quot;:1,\&quot;maxRestockingLevel\&quot;:32,\&quot;minRestockingLevel\&quot;:0,\&quot;createdAt\&quot;:\&quot;1567787309\&quot;,\&quot;updatedAt\&quot;:\&quot;1567787309\&quot;,\&quot;isActive\&quot;:true},</span>
<span class="s2">      {\&quot;sku\&quot;:\&quot;4900002520\&quot;,\&quot;itemPrice\&quot;:1.99,\&quot;productName\&quot;:\&quot;Ruffles\&quot;,\&quot;unitsOnHand\&quot;:1,\&quot;maxRestockingLevel\&quot;:12,\&quot;minRestockingLevel\&quot;:0,\&quot;createdAt\&quot;:\&quot;1567787309\&quot;,\&quot;updatedAt\&quot;:\&quot;1567787309\&quot;,\&quot;isActive\&quot;:true}</span>
<span class="s2">    ]}&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;json&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;statusCode&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



</details>

<p>In this particular example, the customer purchased <code>1 item of Water (Dejablue) (sku 7800009257)</code> and <code>3 items of Mountain Dew (sku 1200050408)</code>
You can compare the <code>unitsOnHand</code> of each sku from the previous inventory data in step 1.</p>
<div class="codehilite"><pre><span></span><code>curl -X GET http://localhost:48095/auditlog
</code></pre></div>

<details>
  <summary><i>(Click to Expand)</i> Audit Log API Response Example</summary>

<p>
The audit log has a new transaction that corresponds to this customer interaction. It also contains the original stocker interaction.
</p>

<p>
The (altered) contents of <a href="https://github.com/intel-iot-devkit/automated-checkout/blob/master/ms-inventory/auditlog.json"><code>ms-inventory/auditlog.json</code></a> are contained in the <code>content</code> key below.
</p>


<div class="codehilite"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{\&quot;data\&quot;:[</span>
<span class="s2">    {\&quot;cardId\&quot;:\&quot;\&quot;,\&quot;accountId\&quot;:0,\&quot;roleId\&quot;:0,\&quot;personId\&quot;:0,\&quot;inventoryDelta\&quot;:[{\&quot;SKU\&quot;:\&quot;4900002520\&quot;,\&quot;delta\&quot;:1},{\&quot;SKU\&quot;:\&quot;4900002525\&quot;,\&quot;delta\&quot;:2},{\&quot;SKU\&quot;:\&quot;4900002470\&quot;,\&quot;delta\&quot;:2},{\&quot;SKU\&quot;:\&quot;4900002510\&quot;,\&quot;delta\&quot;:2}],\&quot;createdAt\&quot;:\&quot;1591664096434624545\&quot;,\&quot;auditEntryId\&quot;:\&quot;b0c119ef-e933-44d2-8c14-8a720cc95417\&quot;},</span>
<span class="s2">    {\&quot;cardId\&quot;:\&quot;0003278380\&quot;,\&quot;accountId\&quot;:1,\&quot;roleId\&quot;:1,\&quot;personId\&quot;:1,\&quot;inventoryDelta\&quot;:[{\&quot;SKU\&quot;:\&quot;4900002525\&quot;,\&quot;delta\&quot;:-1},{\&quot;SKU\&quot;:\&quot;4900002510\&quot;,\&quot;delta\&quot;:-1}],\&quot;createdAt\&quot;:\&quot;1591664285876117173\&quot;,\&quot;auditEntryId\&quot;:\&quot;6447cc8f-c2ba-46d9-96cb-0e7c5ab72e8b\&quot;}]}}&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;json&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;statusCode&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



</details>

<div class="codehilite"><pre><span></span><code>curl -X GET http://localhost:48093/ledger
</code></pre></div>

<details>
  <summary><i>(Click to Expand)</i> Ledger API Response Example</summary>

<p>
Note that this API response now includes a financial transaction indicating what was actually removed from the cooler and associated with the customer's transaction. Other accounts in the ledger are still empty since there have been no transactions.
</p>

<p>
The (altered) contents of <a href="https://github.com/intel-iot-devkit/automated-checkout/blob/master/ms-ledger/ledger.json"><code>ms-ledger/ledger.json</code></a> are contained in the <code>content</code> key below.
</p>


<div class="codehilite"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{\&quot;data\&quot;:[</span>
<span class="s2">    {\&quot;accountID\&quot;:1,\&quot;ledgers\&quot;:[{\&quot;transactionID\&quot;:\&quot;1591664279852530807\&quot;,\&quot;txTimeStamp\&quot;:\&quot;1591664279852530890\&quot;,\&quot;lineTotal\&quot;:3.98,\&quot;createdAt\&quot;:\&quot;1591664279852530964\&quot;,\&quot;updatedAt\&quot;:\&quot;1591664279852531037\&quot;,\&quot;isPaid\&quot;:false,\&quot;lineItems\&quot;:[{\&quot;sku\&quot;:\&quot;4900002525\&quot;,\&quot;productName\&quot;:\&quot;Pringles\&quot;,\&quot;itemPrice\&quot;:1.99,\&quot;itemCount\&quot;:1},{\&quot;sku\&quot;:\&quot;4900002510\&quot;,\&quot;productName\&quot;:\&quot;Gatorade - 16.9 oz\&quot;,\&quot;itemPrice\&quot;:1.99,\&quot;itemCount\&quot;:1}]}]},</span>
<span class="s2">    {\&quot;accountID\&quot;:2,\&quot;ledgers\&quot;:[]},</span>
<span class="s2">    {\&quot;accountID\&quot;:3,\&quot;ledgers\&quot;:[]},</span>
<span class="s2">    {\&quot;accountID\&quot;:4,\&quot;ledgers\&quot;:[]},</span>
<span class="s2">    {\&quot;accountID\&quot;:5,\&quot;ledgers\&quot;:[]},</span>
<span class="s2">    {\&quot;accountID\&quot;:6,\&quot;ledgers\&quot;:[]}</span>
<span class="s2">  ]}&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;json&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;statusCode&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>


</details>

<p>From the ledger data, notice the transaction done by accountID 1.</p>
<div class="codehilite"><pre><span></span><code><span class="s2">&quot;{\&quot;accountID\&quot;:1,</span>
<span class="s2"> \&quot;ledgers\&quot;:[{\&quot;transactionID\&quot;:\&quot;1585679067654735828\&quot;,</span>
<span class="s2">    \&quot;txTimeStamp\&quot;:\&quot;1585679067654735975\&quot;,</span>
<span class="s2">    \&quot;lineTotal\&quot;:7.96,</span>
<span class="s2">    \&quot;createdAt\&quot;:\&quot;1585679067654736044\&quot;,</span>
<span class="s2">    \&quot;updatedAt\&quot;:\&quot;1585679067654736110\&quot;,</span>
<span class="s2">    \&quot;isPaid\&quot;:false,</span>
<span class="s2">    \&quot;lineItems\&quot;:[</span>
<span class="s2">                   {\&quot;sku\&quot;:\&quot;4900002525\&quot;,\&quot;productName\&quot;:\&quot;Pringles\&quot;,\&quot;itemPrice\&quot;:1.99,\&quot;itemCount\&quot;:1},</span>
<span class="s2">                   {\&quot;sku\&quot;:\&quot;4900002510\&quot;,\&quot;productName\&quot;:\&quot;Gatorade - 16.9 oz\&quot;,\&quot;itemPrice\&quot;:1.99,\&quot;itemCount\&quot;:1}</span>
<span class="s2">                  ]</span>
<span class="s2">            }]}&quot;</span><span class="w"></span>
</code></pre></div>

<h3 id="3-the-cooler-requires-maintenance">3. The cooler requires maintenance</h3>
<p>In this scenario, all Automated Checkout services are operating as usual, except the following conditions are present:</p>
<ul>
<li>The cooler has exceeded the maximum allowable temperature threshold of 83 degrees Fahrenheit</li>
<li>It has stayed at or above this temperature threshold for more than 15 seconds</li>
</ul>
<p align="center">
    <img src="../images/maintenance.png">
</p>

<details>
  <summary><i>(Click to Expand)</i> Technical note about temperature</summary>

<p>
The <code>as-controller-board-status</code> service takes temperature readings regularly and calculates the average temperature over a configurable amount of time. If the average temperature over this duration exceeds the thresholds defined in the <code>as-controller-board-status</code> service's configured value, it will cause the cooler to enter maintenance mode and it will attempt to send a notification. The frequency of notifications can be configured as well.
</p>

<p>
If the temperature temporarily exceeds the maximum or minimum allowable temperature thresholds, but does not push the time-averaged temperature above or below the thresholds, no notification will be sent.
</p>

</details>

<p>When the Automated Checkout is in an unstable state such as the one presented above, it enters <em>maintenance mode</em>. When the Automated Checkout is in this state, it automatically denies access to everyone except individuals that possess badges that are associated with the maintenance worker role.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Maintenance mode is triggered in a few conditions:</p>
<ul>
<li>Minimum or maximum temperature thresholds exceeded over a time-averaged temperature</li>
<li>The cooler door is left open for too long</li>
<li>The inferencing service is not responsive upon badge swipe</li>
<li>The inferencing service is not responsive upon an inferencing request</li>
</ul>
</div>
<p>This scenario walks through the following steps:</p>
<ol>
<li>Set the temperature to a value above the default maximum temperature threshold</li>
<li>Continue to set the temperature until the time-averaged temperature is above the default maximum temperature threshold</li>
<li>Simulate a maintenance worker swiping their badge to maintain the cooler</li>
<li>Reset the temperature back to normal</li>
<li>Verify that maintenance mode is no longer active</li>
</ol>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>This sequence of events is time-sensitive. Once started, you must continue the sequence.</strong></p>
<p>This sequence differs from the other scenarios leading up to this point. It does not require the cooler door to be opened.</p>
<p>It's OK to run the commands without critically analyzing them <em>in the moment</em>. You may find it most useful to review them in advance.</p>
<p>If you mess up, you should start fresh. Run the command <code>make down &amp;&amp; make clean-docker &amp;&amp; make run</code> to scrub the Automated Checkout data and containers, wait approximately one minute after all services have started, and begin again. This scenario does not have any dependencies on the other scenarios in phase 1.</p>
</div>
<p>To begin the scenario, first start by setting the temperature of the cooler to <code>99.00</code> degrees Fahrenheit. The following command will make a REST API call to the <code>ds-controller-board</code> service <strong><em>(time sensitive)</em></strong>:</p>
<div class="codehilite"><pre><span></span><code>curl -X PUT -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -d <span class="s1">&#39;{&quot;setTemperature&quot;:&quot;99.00&quot;}&#39;</span> http://localhost:48097/api/v2/device/name/controller-board/setTemperature
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There should not be any response message when running this EdgeX command successfully.</p>
</div>
<p>Repeat this command once or twice, over a span of 15 seconds to establish an average.</p>
<p>During this waiting period, periodically check the status of maintenance mode. The following command will make a REST API call to the <code>as-vending</code> service <strong><em>(no longer time sensitive)</em></strong>:</p>
<div class="codehilite"><pre><span></span><code>curl -X GET http://localhost:48099/maintenanceMode
</code></pre></div>

<details>
  <summary><i>(Click to Expand)</i> Expected Output</summary>

<p>
The value of <code>maintenanceMode</code> will switch to <code>true</code> from <code>false</code> once the time-averaged temperature exceeds the maximum temperature threshold (default 83 degrees Fahrenheit):
</p>


<div class="codehilite"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{\&quot;maintenanceMode\&quot;:true}&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;json&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;statusCode&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



</details>

<p>The following diagram represents the flow for setting the temperature and setting maintenance mode to true:</p>
<p align="center">
    <img src="../images/maintenance-mode.png">
</p>

<p>The next step involves a maintenance worker swiping their badge to resolve the issue. When a maintenance worker swipes their badge, maintenance mode is reset.</p>
<p>For the sake of simplicity in this walkthrough, we will first fix the temperature of the cooler and <em>then</em> the maintenance worker will swipe their badge to fix maintenance mode. The reason the maintenance worker would have to swipe their badge twice is because maintenance mode will be set to <code>false</code> immediately, but it will be immediately set back to <code>true</code> once the next temperature reading arrives. So, to avoid swiping the badge twice, the temperature will be reset before swiping.</p>
<p>First, set the temperature to a normal value (45 degrees) a few times over the span of 15 seconds (minimum) <strong><em>(time sensitive)</em></strong>:</p>
<div class="codehilite"><pre><span></span><code>curl -X PUT -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -d <span class="s1">&#39;{&quot;setTemperature&quot;:&quot;45.00&quot;}&#39;</span> http://localhost:48097/api/v2/device/name/controller-board/setTemperature
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There should not be any response message when running this EdgeX command successfully.</p>
</div>
<p>Now that a new, proper average temperature value has been set, the maintenance worker can proceed to swipe their card, fix the cooler, and set the maintenance mode back to false.</p>
<p>To do this, follow a familiar step, only this time use a card that has been assigned to a maintenance worker role <strong><em>(not time sensitive)</em></strong>:</p>
<div class="codehilite"><pre><span></span><code>curl -X PUT -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -d <span class="s1">&#39;{&quot;card-number&quot;:&quot;0003278385&quot;}&#39;</span> http://localhost:48098/api/v2/device/name/card-reader/card-number
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There should not be any response message when running this EdgeX command successfully.</p>
</div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>The card <code>0003278385</code> is assigned to the maintenance worker role, and a person with ID 1. Additionally, if the maintenance worker opens and closes the door, there will be a corresponding audit log entry for that door open/close event.</p>
</div>
<p>Now, check that maintenance mode has been reset using a familiar command <strong><em>(not time sensitive)</em></strong>:</p>
<div class="codehilite"><pre><span></span><code>curl -X GET http://localhost:48099/maintenanceMode
</code></pre></div>

<details>
  <summary><i>(Click to Expand)</i> Expected Output</summary>

<p>
The value of <code>maintenanceMode</code> will switch to <code>true</code> from <code>false</code> once the time-averaged temperature exceeds the maximum temperature threshold (default 83 degrees Fahrenheit):
</p>


<div class="codehilite"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{\&quot;maintenanceMode\&quot;:false}&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;contentType&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;json&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;statusCode&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



</details>

<p>This is the end of the scenario, and should provide an essential understanding of maintenance mode as well as temperature reactions in the Automated Checkout reference implementation.</p>
<h2 id="summary">Summary</h2>
<p>You have successfully run through a typical Automated Checkout workflow using simulated interactions and devices. In the other phases of this reference implementation, we ramp up to using physical devices and provide guidance on writing new services for your custom devices and needs.</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../index.html" class="md-footer__link md-footer__link--prev" aria-label="Previous: Automated Checkout Reference Implementation" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Automated Checkout Reference Implementation
            </div>
          </div>
        </a>
      
      
        
        <a href="phase2.html" class="md-footer__link md-footer__link--next" aria-label="Next: Phase 2 - Add Card Reader Device" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Phase 2 - Add Card Reader Device
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.5bf1dace.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.078830c0.min.js"></script>
      
        <script src="https://unpkg.com/lunr/lunr.js"></script>
      
    
  </body>
</html>