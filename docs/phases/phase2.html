
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.0, mkdocs-material-8.5.6">
    
    
      
        <title>Phase 2 - Add Card Reader Device - Automated Checkout</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.20d9efc8.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#phase-2-add-card-reader-device" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../index.html" title="Automated Checkout" class="md-header__button md-logo" aria-label="Automated Checkout" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Automated Checkout
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Phase 2 - Add Card Reader Device
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="Automated Checkout" class="md-nav__button md-logo" aria-label="Automated Checkout" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Automated Checkout
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        Automated Checkout Reference Implementation
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Phases
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Phases" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Phases
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="phase1.html" class="md-nav__link">
        Phase 1 - Simulation Mode
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Phase 2 - Add Card Reader Device
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="phase2.html" class="md-nav__link md-nav__link--active">
        Phase 2 - Add Card Reader Device
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    Setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#plug-in-the-card-reader-device" class="md-nav__link">
    Plug in the card reader device
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-the-ds-card-reader-service-to-use-the-card-reader-device" class="md-nav__link">
    Configure the ds-card-reader service to use the card reader device
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run-the-automated-checkout-reference-implementation" class="md-nav__link">
    Run the Automated Checkout reference implementation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dive-deeper" class="md-nav__link">
    Dive deeper
  </a>
  
    <nav class="md-nav" aria-label="Dive deeper">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#extending-the-card-reader" class="md-nav__link">
    Extending the card reader
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-new-cards" class="md-nav__link">
    Adding new cards
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-the-updated-service" class="md-nav__link">
    Running the updated service
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="phase3.html" class="md-nav__link">
        Phase 3 - Bring Your Own Hardware and Software
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Additional Documentation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Additional Documentation" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Additional Documentation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1" type="checkbox" id="__nav_3_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3_1">
          Automated Checkout Services
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Automated Checkout Services" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          Automated Checkout Services
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../automated-checkout-services/device_services.html" class="md-nav__link">
        Device Services
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../automated-checkout-services/application_services.html" class="md-nav__link">
        Application Services
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../automated-checkout-services/micro_services.html" class="md-nav__link">
        Other Microservices
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../events.html" class="md-nav__link">
        Automated Checkout Events
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../configuration.html" class="md-nav__link">
        Configuration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../modifying_source_code.html" class="md-nav__link">
        Modifying source code
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../notifications.html" class="md-nav__link">
        How to Send Notifications through EdgeX (optional)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../references.html" class="md-nav__link">
        References
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../troubleshooting.html" class="md-nav__link">
        Troubleshooting
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    Setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#plug-in-the-card-reader-device" class="md-nav__link">
    Plug in the card reader device
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-the-ds-card-reader-service-to-use-the-card-reader-device" class="md-nav__link">
    Configure the ds-card-reader service to use the card reader device
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run-the-automated-checkout-reference-implementation" class="md-nav__link">
    Run the Automated Checkout reference implementation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dive-deeper" class="md-nav__link">
    Dive deeper
  </a>
  
    <nav class="md-nav" aria-label="Dive deeper">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#extending-the-card-reader" class="md-nav__link">
    Extending the card reader
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-new-cards" class="md-nav__link">
    Adding new cards
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-the-updated-service" class="md-nav__link">
    Running the updated service
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="phase-2-add-card-reader-device">Phase 2 - Add Card Reader Device</h1>
<p>In <a href="phase1.html">phase 1</a>, the scenarios presented a breakdown of the various modes, events, and services that are working together within the Automated Checkout reference implementation. Everything in phase 1 was simulated and all interactions were done via REST API calls.</p>
<p>Phase 2 will be mostly the same, except there will now be a physical card reader device. This device is actually just a keyboard that types 10 digits and then presses enter, which is what a common RFID card reader also might do.</p>
<h2 id="setup">Setup</h2>
<p>If the Automated Checkout services are still running from phase 1, the services can stay running. The only service that will be terminated and re-created is <code>ds-card-reader</code> (which will be done as part of this guide).</p>
<p>Start by removing the <code>ds-card-reader</code> service. In order to do this, first identify the container's name using this command:</p>
<div class="codehilite"><pre><span></span><code>docker ps <span class="p">|</span> grep -i ds-card-reader
</code></pre></div>

<p>Use the output of that command to stop the container for <code>ds-card-reader</code> - replace <code>container_name_or_id_from_previous_command</code> with the output from above:</p>
<div class="codehilite"><pre><span></span><code>docker rm -f container_name_or_id_from_previous_command
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you encounter any issues with the <code>ds-card-reader</code> later in this guide, consider cleaning up all of the Automated Checkout services. The best way to guarantee a clean run through of this phase is to tear down any existing Automated Checkout environment and start from fresh. This can be accomplished by running the following steps.</p>
<p>Navigate to the root of this repository - this can vary based on where you chose to clone the repository:</p>
<p><code>cd &lt;repository_root&gt;</code></p>
<p>Run the following commands to clean things up:</p>
<p><code>make down &amp;&amp; make clean-docker</code></p>
<p>This will destroy any existing ledger entries, audit log entries, inventory changes, and EdgeX event readings and data associated with Automated Checkout. However, this will not alter any other non-Automated Checkout Docker images, containers, or volumes. The scope of the above command is limited to only Automated Checkout.</p>
</div>
<h2 id="plug-in-the-card-reader-device">Plug in the card reader device</h2>
<p>The first step is to simply plug in the card reader device. This can be a regular USB keyboard or a dedicated RFID card reader, or any other HID keyboard-like input device that works with <a href="https://en.wikipedia.org/wiki/Evdev"><code>evdev</code></a> and can be identified via the Linux command <code>lsusb</code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you are going to use a keyboard as a card reader device, we suggest plugging in a second keyboard for this purpose.</p>
</div>
<p>Once it's plugged in, proceed to identify the device by running the command:</p>
<div class="codehilite"><pre><span></span><code>lsusb
</code></pre></div>

<p>The output may look like this (this is the output from a virtual machine):</p>
<div class="codehilite"><pre><span></span><code>Bus 002 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub
Bus 001 Device 003: ID ffff:0035
Bus 001 Device 002: ID 80ee:0021 VirtualBox USB Tablet
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
</code></pre></div>

<p>The particular <em>vendor ID</em> and <em>product ID</em> are spelled out clearly for each USB device. The card reader input device itself has been plugged in and has the vendor ID <code>ffff</code> and the product ID <code>0035</code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The VID and PID values are hexadecimal, base 16. A value of <code>ffff</code> is equal to <code>65535</code> in decimal, base 10, and <code>0035</code> in base 16 is equal to <code>53</code> in base 10. The configuration files in the Automated Checkout reference implementation device services may require some conversion between the two. If needed, consider searching online for a hexadecimal to decimal conversion calculator to make the process easier.</p>
</div>
<p>Once the VID and PID have been identified, the next step is to configure the <code>ds-card-reader</code> device service to grab that device and listen for input events.</p>
<h2 id="configure-the-ds-card-reader-service-to-use-the-card-reader-device">Configure the <code>ds-card-reader</code> service to use the card reader device</h2>
<p>From the root of this repository, with the card reader device plugged in and its VID and PID identified, navigate to the <code>ds-card-reader/res/docker</code> directory:</p>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span> &lt;repository_root&gt;
</code></pre></div>

<p>Then, modify the <code>docker-compose.physical.card-reader.yml</code> file in your text editor of choice:</p>
<div class="codehilite"><pre><span></span><code>nano docker-compose.physical.card-reader.yml
</code></pre></div>

<p>In this file, you'll see a section that looks like this:</p>
<div class="codehilite"><pre><span></span><code><span class="nt">ds-card-reader</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0:0&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">devices</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/dev/input:/dev/input</span><span class="w"></span>
<span class="w">  </span><span class="nt">environment</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">DRIVERCONFIG_SIMULATEDEVICE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;false&quot;</span><span class="w"></span>
</code></pre></div>

<p>We will be adding three environment variables to this service:</p>
<ul>
<li><code>DeviceSearchPath</code> - the path to search for <code>evdev</code> input devices</li>
<li><code>VID</code> - the base-10 value of the vendor ID associated with the input device</li>
<li><code>PID</code> - the base-10 value of the product ID associated with the input device</li>
</ul>
<p>First, verify that the default value of <code>DeviceSearchPath="/dev/input/event*"</code> corresponds to an actual path on your Linux system - the vast majority of Linux systems should automatically handle everything in this directory, but it helps to check.</p>
<div class="codehilite"><pre><span></span><code>ls -al /dev/input/event
</code></pre></div>

<details>
  <summary><i>(Click to Expand)</i> Example Output</summary>

<p>
The output of <code>ls -al /dev/input/event</code> may look like this:
</p>


<div class="codehilite"><pre><span></span><code>crw-rw---- 1 root input 13, 64 Apr  9 09:10 /dev/input/event0
crw-rw---- 1 root input 13, 65 Apr  9 09:10 /dev/input/event1
crw-rw---- 1 root input 13, 66 Apr  9 09:10 /dev/input/event2
crw-rw---- 1 root input 13, 67 Apr  9 09:10 /dev/input/event3
crw-rw---- 1 root input 13, 68 Apr  9 09:10 /dev/input/event4
crw-rw---- 1 root input 13, 69 Apr  9 09:10 /dev/input/event5
crw-rw---- 1 root input 13, 70 Apr  9 09:10 /dev/input/event6
crw-rw---- 1 root input 13, 71 Apr  9 09:58 /dev/input/event7
</code></pre></div>



<p>
If you do not see input devices under this path, your Linux kernel or operating system may be configured differently. Consult your operating system's documentation for information regarding the behavior of input devices if possible.
</p>

</details>

<p>The resulting section in the configuration file will look something like this:</p>
<div class="codehilite"><pre><span></span><code><span class="nt">ds-card-reader</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0:0&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">devices</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/dev/input:/dev/input</span><span class="w"></span>
<span class="w">  </span><span class="nt">environment</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">DRIVERCONFIG_SIMULATEDEVICE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;false&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nt">DRIVERCONFIG_DEVICESEARCHPATH</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/dev/input/event*&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nt">DRIVERCONFIG_VID</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">65535</span><span class="w"> </span><span class="c1"># 0xFFFF</span><span class="w"></span>
<span class="w">    </span><span class="nt">DRIVERCONFIG_PID</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">53</span><span class="w">    </span><span class="c1"># 0x0035</span><span class="w"></span>
</code></pre></div>

<h2 id="run-the-automated-checkout-reference-implementation">Run the Automated Checkout reference implementation</h2>
<p>Run the Automated Checkout reference implementation with the physical card reader component included:</p>
<div class="codehilite"><pre><span></span><code>make run-physical-card-reader
</code></pre></div>

<p>After about a minute or so, the card reader device service (ds-card-reader) will be configured to accept inputs from an external card reader device. Follow the steps outlined in <a href="phase1.html#walkthrough-of-scenarios">phase 1</a> again, <strong>except</strong> instead of performing REST API calls to simulate badge swipe events, replace them with a keyboard inputs that correspond to the same cards ID, press <code>enter</code>, and then continue forward with the REST API calls that simulate door open/closure events, temperature changes, etc.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You do not need to type the card ID number anywhere specifically. The card reader device service is configured in such a way that it will listen to any inputs from the keyboard at any time.</p>
<p>The input device is globally grabbed using <a href="https://www.x.org/releases/X11R7.6/doc/man/man4/evdev.4.xhtml">evdev's <code>GrabDevice</code></a> mechanism, summarized here:</p>
<blockquote>
<p><strong>GrabDevice</strong>: ... Doing so will ensure that no other driver can initialise the same device and it will also stop the device from sending events to /dev/kbd or /dev/input/mice. Events from this device will not be sent to virtual devices (e.g. rfkill or the Macintosh mouse button emulation).</p>
</blockquote>
</div>
<p>For example, in <a href="phase1.html#walkthrough-of-scenarios">phase 1</a>, the card number for the stocker role is <code>0003293374</code>. This card number can be simulated by typing the digits and pressing the enter key, if you're using a keyboard as your input device.</p>
<h2 id="dive-deeper">Dive deeper</h2>
<p>Now that the card reader is working with a physical device, it may be time to make some changes to the underlying authentication data to allow your own cards to authenticate. The following sections illustrate the steps needed in order to extend the Automated Checkout reference implementation to work with your cards.</p>
<h3 id="extending-the-card-reader">Extending the card reader</h3>
<p>If the behavior of your particular card reader device's cards does not match the behavior that's been incorporated into this service, you'll need to get your hands dirty with the source code of the <code>ds-card-reader</code> device service.</p>
<p>In the service, take a look at the file <code>ds-card-reader/device/physical.go</code>. This file contains this function:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">reader</span><span class="w"> </span><span class="o">*</span><span class="nx">CardReaderPhysical</span><span class="p">)</span><span class="w"> </span><span class="nx">Listen</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span><span class="w"></span>
<span class="w">    </span><span class="nx">reader</span><span class="p">.</span><span class="nx">processDevReadEvents</span><span class="p">(</span><span class="nx">events</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p><code>Listen</code> is a Go routine that loops and processes <code>evdev</code> events as they come in from the physical input device. Carefully inspect this section of code as well as the functions called within this Go routine in order to gain an understanding of how to change the behavior of the card reader device service.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Changing the source code may break unit tests and other functionality across services. Ensure that the software development processes used to make code changes include updating unit and integration tests to work with new changes.</p>
</div>
<h3 id="adding-new-cards">Adding new cards</h3>
<p>The <code>ms-authentication</code> microservice contains an index of all cards, accounts, and authorized individuals (people). To add a new card, person, or account, follow these steps.</p>
<p>First, navigate to the <code>ms-authentication</code> directory in the root of the repository. These three <code>.json</code> files dictate the <code>ms-authentication</code> service's behavior:</p>
<ul>
<li><a href="https://github.com/intel-iot-devkit/automated-checkout/blob/master/ms-authentication/people.json"><code>people.json</code></a></li>
<li><a href="https://github.com/intel-iot-devkit/automated-checkout/blob/master/ms-authentication/accounts.json"><code>accounts.json</code></a></li>
<li><a href="https://github.com/intel-iot-devkit/automated-checkout/blob/master/ms-authentication/cards.json"><code>cards.json</code></a></li>
</ul>
<p>In this case, we're only going to add a new card and associate it with the person with ID 1. A typical card will look like this:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;cardId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0003621892&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;roleId&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;isValid&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;personId&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;createdAt&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1560815799&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;updatedAt&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1560815799&quot;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>Let's add a new card to the <code>cards.json</code> file - replace <code>1234567899</code> with a 10-digit card that corresponds to one of your cards:</p>
<div class="codehilite"><pre><span></span><code><span class="err">...</span><span class="p">,</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;cardId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1234567899&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;roleId&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;isValid&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;personId&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;createdAt&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1560815799&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;updatedAt&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1560815799&quot;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="err">...</span><span class="w"></span>
</code></pre></div>

<div class="admonition info">
<p class="admonition-title">Info</p>
<p>The <code>createdAt</code> and <code>updatedAt</code> dates do not particularly matter, but should be kept as a Unix timestamp.</p>
</div>
<p>Now that we've added the card to the <code>cards.json</code> file, the service's Docker image must be rebuilt. Navigate to the root of this repository, which should be up a single directory:</p>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span> ..
</code></pre></div>

<p>Then, use the <code>Makefile</code> to build the <code>ds-card-reader</code> image:</p>
<div class="codehilite"><pre><span></span><code>make ds-card-reader
</code></pre></div>

<div class="admonition info">
<p class="admonition-title">Info</p>
<p>At this time, the three <code>.json</code> files are built in to the Docker image for the <code>ms-authentication</code> service. They are not mounted at runtime. This is why image rebuilding is necessary.</p>
</div>
<h3 id="running-the-updated-service">Running the updated service</h3>
<p>If the Automated Checkout services are already running, the best way to update the running <code>ms-authentication</code> service is to remove the <code>ms-authentication</code> container and then re-run the command to bring up the whole stack.</p>
<p>First, remove the <code>ms-authentication</code> container:</p>
<div class="codehilite"><pre><span></span><code>docker ps -a <span class="p">|</span> grep -i ms-authentication
</code></pre></div>

<p>Use the output of the last command to delete the <code>ms-authentication</code> container. Replace <code>container_name</code> in the below command with the name from the output from the above command to delete it:</p>
<div class="codehilite"><pre><span></span><code>docker rm -f container_name
</code></pre></div>

<p>Then, bring up the services using the same command from before:</p>
<div class="codehilite"><pre><span></span><code>make run-physical-card-reader
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If this fails to properly update the image, it may be worth running</p>
<p><code>make down</code></p>
<p>And then re-running</p>
<p><code>make run-physical-card-reader</code></p>
<p>If there are still issues, consider completely cleaning the Automated Checkout containers and volumes by running</p>
<p><code>make down &amp;&amp; make clean-docker</code></p>
<p>And then running</p>
<p><code>make run-physical-card-reader</code></p>
</div>
<p>The <code>ds-card-reader</code> service should be listening for input events. If your card reader device is a proper RFID USB card reader, swipe the card that corresponds to the card we added, or if it's a USB keyboard, type out the keys and press enter when done, and follow the steps in phase 1 while replacing card reader badge-in events with this method.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>For more generalized information on modifying source code, please review the <a href="../modifying_source_code.html">Modifying source code</a> page.</p>
</div>
<h2 id="summary">Summary</h2>
<p>The usage of a physical card reader device only requires a few changes from the simulated mode. In the <code>ds-card-reader</code> device service, the device's VID and PID are configured, the service's image gets rebuilt, and the service itself gets updated to use the new image. The device's interactions are captured by Go routines running in the device service itself, and EdgeX event readings are propagated throughout a handful of services to ensure a smooth Automated Checkout workflow.</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="phase1.html" class="md-footer__link md-footer__link--prev" aria-label="Previous: Phase 1 - Simulation Mode" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Phase 1 - Simulation Mode
            </div>
          </div>
        </a>
      
      
        
        <a href="phase3.html" class="md-footer__link md-footer__link--next" aria-label="Next: Phase 3 - Bring Your Own Hardware and Software" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Phase 3 - Bring Your Own Hardware and Software
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.5bf1dace.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.078830c0.min.js"></script>
      
        <script src="https://unpkg.com/lunr/lunr.js"></script>
      
    
  </body>
</html>